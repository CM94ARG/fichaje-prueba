// ============================================
// NUEVA FUNCIÓN: Registrar acción manual (entrada O salida)
// ============================================

function registrarAccionManual(datos) {
  try {
    const ss = SpreadsheetApp.openById(DB_SPREADSHEET_ID);
    const dni = datos.dni;
    const tipo = datos.tipo; // 'entrada' o 'salida'
    
    if (!EMPLEADOS[dni]) {
      throw new Error("DNI no encontrado");
    }
    
    const nombreEmpleado = EMPLEADOS[dni].nombre;
    const hoja = obtenerHojaEmpleado(ss, nombreEmpleado);
    
    // Crear fecha/hora
    const fechaHora = new Date(datos.fecha + ' ' + datos.hora);
    const local = datos.local.toUpperCase();
    
    if (tipo === 'entrada') {
      // Agregar NUEVA entrada
      hoja.appendRow([
        dni,
        fechaHora,
        "", // Salida vacía
        local,
        "", // Horas vacías
        "Registro manual admin",
        "Panel administrador",
        "N/A",
        "N/A",
        "IP administrador"
      ]);
      
      registrarAuditoriaManual(dni, nombreEmpleado, fechaHora, null, local, "Entrada manual");
      
      return crearRespuesta({
        success: true,
        message: `✅ Entrada registrada manualmente para ${nombreEmpleado} en ${local}`,
        tipo: "entrada",
        fechaHora: Utilities.formatDate(fechaHora, "America/Argentina/Buenos_Aires", "dd/MM/yyyy HH:mm")
      });
      
    } else if (tipo === 'salida') {
      // Buscar última entrada sin salida
      const entradaPendiente = buscarEntradaPendiente(dni);
      
      if (entradaPendiente) {
        // Cerrar entrada pendiente
        const horas = calcularHorasTrabajadas(entradaPendiente.entrada, fechaHora);
        
        hoja.getRange(entradaPendiente.fila, 3).setValue(fechaHora); // Columna C: Salida
        hoja.getRange(entradaPendiente.fila, 5).setValue(horas); // Columna E: Horas
        
        registrarAuditoriaManual(dni, nombreEmpleado, entradaPendiente.entrada, fechaHora, local, "Salida manual (cierre entrada pendiente)");
        
        return crearRespuesta({
          success: true,
          message: `✅ Salida registrada manualmente para ${nombreEmpleado}. Se cerró la entrada pendiente. ${horas} horas trabajadas.`,
          tipo: "salida",
          fechaHora: Utilities.formatDate(fechaHora, "America/Argentina/Buenos_Aires", "dd/MM/yyyy HH:mm"),
          horas: horas
        });
        
      } else {
        // No hay entrada pendiente - crear nueva fila solo con salida (raro pero posible)
        hoja.appendRow([
          dni,
          "", // Entrada vacía
          fechaHora,
          local,
          "0.00", // 0 horas
          "Registro manual admin",
          "Panel administrador",
          "N/A",
          "N/A",
          "IP administrador"
        ]);
        
        registrarAuditoriaManual(dni, nombreEmpleado, null, fechaHora, local, "Salida manual (sin entrada)");
        
        return crearRespuesta({
          success: true,
          message: `✅ Salida registrada manualmente para ${nombreEmpleado} en ${local}. Nota: No se encontró entrada pendiente.`,
          tipo: "salida",
          fechaHora: Utilities.formatDate(fechaHora, "America/Argentina/Buenos_Aires", "dd/MM/yyyy HH:mm")
        });
      }
    } else {
      throw new Error("Tipo de acción no válido");
    }
    
  } catch (error) {
    Logger.log("❌ Error en registro manual: " + error.toString());
    return crearRespuesta({ 
      success: false, 
      error: "Error al registrar: " + error.message 
    });
  }
}

// ============================================
// FUNCIÓN DE AUDITORÍA PARA REGISTROS MANUALES
// ============================================

function registrarAuditoriaManual(dni, nombreEmpleado, entrada, salida, local, motivo) {
  try {
    const ss = SpreadsheetApp.openById(DB_SPREADSHEET_ID);
    let hojaAuditoria = ss.getSheetByName("AUDITORIA_MANUAL");
    
    if (!hojaAuditoria) {
      hojaAuditoria = ss.insertSheet("AUDITORIA_MANUAL");
      hojaAuditoria.appendRow([
        "Fecha Registro", "DNI", "Nombre Empleado", "Fecha Hora Entrada",
        "Fecha Hora Salida", "Local", "Motivo", "Realizado Por",
        "Observaciones"
      ]);
      
      hojaAuditoria.getRange("A1:I1").setFontWeight("bold");
      hojaAuditoria.setFrozenRows(1);
      hojaAuditoria.autoResizeColumns(1, 9);
      
      hojaAuditoria.getRange("A:A").setNumberFormat('dd/MM/yyyy HH:mm:ss');
      hojaAuditoria.getRange("D:E").setNumberFormat('dd/MM/yyyy HH:mm:ss');
    }
    
    const auditoria = [
      new Date(),
      dni,
      nombreEmpleado,
      entrada,
      salida,
      local,
      motivo,
      "Administrador",
      "Registro desde panel admin"
    ];
    
    hojaAuditoria.appendRow(auditoria);
    
  } catch (error) {
    Logger.log("Error en registro de auditoría: " + error);
  }
}

// ============================================
// ACTUALIZAR doPost() para manejar 'registroManual'
// ============================================

// En tu función doPost(), dentro de las acciones del admin, AGREGA esto:
if (datos.action === "registroManual") {
  return registrarAccionManual(datos);
}
