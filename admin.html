<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Admin - Sistema de Fichaje</title>
    <style>
        /* ... TODO EL CSS ANTERIOR ... (no cambia) */
    </style>
</head>
<body>
    <div class="container">
        <!-- ... TODO EL HTML ANTERIOR ... (no cambia) -->
    </div>

    <script>
        // ============================================
        // CONFIGURACIÓN
        // ============================================
        const API_URL = 'https://script.google.com/macros/s/AKfycbyQVKHBWJRI42wGyPEL5sy5w6NcVKGCVHWT6HqPSTq_pK4RmPb_hPjXRqwEeFQSBr8I/exec';
        
        // Variables globales
        let empleadoSeleccionado = null;
        
        // ============================================
        // FUNCIONES DE LOGIN - ¡MODIFICADO PARA USAR FormData!
        // ============================================
        
        async function login() {
            const password = document.getElementById('password').value;
            const loginBtn = document.getElementById('loginBtn');
            const loginError = document.getElementById('loginError');
            
            if (!password) {
                showError(loginError, 'Por favor ingrese la contraseña');
                return;
            }
            
            loginBtn.disabled = true;
            loginBtn.textContent = 'Verificando...';
            loginError.style.display = 'none';
            
            try {
                // ¡USAR FormData COMO EN EL INDEX!
                const formData = new FormData();
                formData.append('action', 'loginDueno');
                formData.append('password', password);
                
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: formData  // ← ¡Sin headers!
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAdminPanel();
                    cargarEmpleados();
                } else {
                    showError(loginError, data.error || 'Contraseña incorrecta');
                }
            } catch (error) {
                showError(loginError, 'Error de conexión. Verifique la URL del API.');
                console.error('Login error:', error);
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'Ingresar';
                document.getElementById('password').value = '';
            }
        }
        
        // ============================================
        // FUNCIONES DE EMPLEADOS - ¡MODIFICADO PARA USAR FormData!
        // ============================================
        
        async function cargarEmpleados() {
            showLoading(true);
            
            try {
                // ¡USAR FormData!
                const formData = new FormData();
                formData.append('action', 'getEmpleados');
                
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: formData  // ← ¡Sin headers!
                });
                
                const data = await response.json();
                
                if (data.success) {
                    renderEmpleados(data.empleados);
                } else {
                    showError('errorAlert', 'Error al cargar empleados');
                }
            } catch (error) {
                showError('errorAlert', 'Error de conexión al cargar empleados');
                console.error('Error cargando empleados:', error);
            } finally {
                showLoading(false);
            }
        }
        
        function renderEmpleados(empleados) {
            const container = document.getElementById('empleadosContainer');
            container.innerHTML = '';
            
            empleados.forEach(empleado => {
                const card = document.createElement('div');
                card.className = 'empleado-card';
                card.onclick = () => seleccionarEmpleado(empleado);
                
                card.innerHTML = `
                    <h3>${empleado.nombre}</h3>
                    <div class="dni">DNI: ${empleado.dni}</div>
                    <div class="badge">Activo</div>
                `;
                
                container.appendChild(card);
            });
        }
        
        // ============================================
        // CIERRE MANUAL - ¡MODIFICADO PARA USAR FormData!
        // ============================================
        
        async function registrarCierreManual() {
            if (!empleadoSeleccionado) {
                showError('errorAlert', 'Por favor seleccione un empleado');
                return;
            }
            
            // Validar campos
            const fechaEntrada = document.getElementById('fechaEntrada').value;
            const horaEntrada = document.getElementById('horaEntrada').value;
            const fechaSalida = document.getElementById('fechaSalida').value;
            const horaSalida = document.getElementById('horaSalida').value;
            const local = document.getElementById('local').value;
            
            if (!fechaEntrada || !horaEntrada || !fechaSalida || !horaSalida || !local) {
                showError('errorAlert', 'Por favor complete todos los campos');
                return;
            }
            
            const btn = document.getElementById('registrarBtn');
            btn.disabled = true;
            btn.textContent = 'Registrando...';
            
            try {
                // ¡USAR FormData!
                const formData = new FormData();
                formData.append('action', 'cierreManual');
                formData.append('dni', empleadoSeleccionado.dni);
                formData.append('fechaEntrada', fechaEntrada);
                formData.append('horaEntrada', horaEntrada);
                formData.append('fechaSalida', fechaSalida);
                formData.append('horaSalida', horaSalida);
                formData.append('local', local);
                
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: formData  // ← ¡Sin headers!
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccess(data.message);
                    
                    // Mostrar información de auditoría
                    document.getElementById('fechaCierre').textContent = new Date().toLocaleString('es-AR');
                    document.getElementById('horasCalculadas').textContent = data.horas + ' horas';
                    document.getElementById('auditoriaInfo').style.display = 'block';
                    
                    // Resetear después de 3 segundos
                    setTimeout(() => {
                        cancelarCierre();
                        cargarEmpleados();
                    }, 3000);
                } else {
                    showError('errorAlert', data.error || 'Error desconocido');
                }
            } catch (error) {
                showError('errorAlert', 'Error de conexión al registrar');
                console.error('Error en cierre manual:', error);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Registrar Cierre Manual';
            }
        }
        
        // ============================================
        // FUNCIONES AUXILIARES (iguales)
        // ============================================
        
        function logout() {
            empleadoSeleccionado = null;
            
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('adminSection').style.display = 'none';
            document.getElementById('cierreForm').style.display = 'none';
            document.querySelector('.logout-btn').style.display = 'none';
            document.getElementById('empleadosContainer').innerHTML = '';
            
            // Limpiar formulario
            const inputs = document.querySelectorAll('#cierreForm input, #cierreForm select');
            inputs.forEach(input => {
                if (input.type !== 'button') {
                    input.value = '';
                }
            });
        }
        
        function showAdminPanel() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('adminSection').style.display = 'block';
            document.querySelector('.logout-btn').style.display = 'block';
        }
        
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }
        
        function showSuccess(message) {
            const alert = document.getElementById('successAlert');
            alert.textContent = message;
            alert.style.display = 'block';
            setTimeout(() => {
                alert.style.display = 'none';
            }, 5000);
        }
        
        function showError(element, message) {
            if (typeof element === 'string') {
                element = document.getElementById(element);
            }
            element.textContent = message;
            element.style.display = 'block';
        }
        
        function clearAlerts() {
            const alerts = document.querySelectorAll('.alert');
            alerts.forEach(alert => {
                alert.style.display = 'none';
            });
        }
        
        function seleccionarEmpleado(empleado) {
            // Deseleccionar todos
            document.querySelectorAll('.empleado-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Seleccionar el nuevo
            event.currentTarget.classList.add('selected');
            empleadoSeleccionado = empleado;
            
            // Mostrar formulario
            mostrarFormularioCierre();
        }
        
        function mostrarFormularioCierre() {
            if (!empleadoSeleccionado) return;
            
            // Actualizar info del empleado
            document.getElementById('empleadoSeleccionado').innerHTML = `
                <strong>Empleado:</strong> ${empleadoSeleccionado.nombre}<br>
                <strong>DNI:</strong> ${empleadoSeleccionado.dni}
            `;
            
            // Establecer fechas por defecto (hoy)
            const hoy = new Date().toISOString().split('T')[0];
            document.getElementById('fechaEntrada').value = hoy;
            document.getElementById('fechaSalida').value = hoy;
            
            // Establecer horas por defecto
            document.getElementById('horaEntrada').value = '08:00';
            document.getElementById('horaSalida').value = '17:00';
            
            // Mostrar formulario
            document.getElementById('cierreForm').style.display = 'block';
            document.getElementById('auditoriaInfo').style.display = 'none';
            
            // Scroll al formulario
            document.getElementById('cierreForm').scrollIntoView({ behavior: 'smooth' });
        }
        
        function cancelarCierre() {
            empleadoSeleccionado = null;
            document.getElementById('cierreForm').style.display = 'none';
            
            // Deseleccionar todos los empleados
            document.querySelectorAll('.empleado-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            clearAlerts();
        }
        
        // ============================================
        // EVENT LISTENERS Y INICIALIZACIÓN
        // ============================================
        
        document.addEventListener('DOMContentLoaded', function() {
            // Enter en el login
            document.getElementById('password').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    login();
                }
            });
        });
    </script>
</body>
</html>
